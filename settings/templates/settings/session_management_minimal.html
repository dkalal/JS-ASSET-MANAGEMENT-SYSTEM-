{% extends 'base.html' %}
{% load static %}

{% block title %}Session Management - Enterprise Asset Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h2 font-bold mb-2">
      <i class="bi bi-people text-primary me-2"></i>Session Management
    </h1>
    <p class="text-muted">Monitor and manage active user sessions</p>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
      <i class="bi bi-arrow-clockwise me-1"></i>Refresh
    </button>
    <button class="btn btn-outline-warning btn-sm" onclick="cleanupSessions()">
      <i class="bi bi-trash3 me-1"></i>Cleanup
    </button>
  </div>
</div>

<!-- Session Statistics -->
<div class="grid grid-cols-1 md:grid-cols-4 mb-6">
  <div class="card">
    <div class="card-body text-center">
      <i class="bi bi-circle-fill display-4 text-success mb-3"></i>
      <h3 class="font-bold mb-1">{{ active_sessions|default:1 }}</h3>
      <p class="text-muted mb-0">Active Sessions</p>
    </div>
  </div>
  <div class="card">
    <div class="card-body text-center">
      <i class="bi bi-people display-4 text-info mb-3"></i>
      <h3 class="font-bold mb-1">{{ unique_users|default:1 }}</h3>
      <p class="text-muted mb-0">Active Users</p>
    </div>
  </div>
  <div class="card">
    <div class="card-body text-center">
      <i class="bi bi-layers display-4 text-warning mb-3"></i>
      <h3 class="font-bold mb-1">{{ concurrent_sessions|default:1 }}</h3>
      <p class="text-muted mb-0">Max Concurrent</p>
    </div>
  </div>
  <div class="card">
    <div class="card-body text-center">
      <i class="bi bi-shield-exclamation display-4 text-danger mb-3"></i>
      <h3 class="font-bold mb-1">{{ failed_logins|default:0 }}</h3>
      <p class="text-muted mb-0">Failed Logins</p>
    </div>
  </div>
</div>

<!-- Active Sessions Table -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="bi bi-list-ul me-2"></i>Active Sessions
    </h5>
  </div>
  <div class="card-body p-0">
    <table class="table mb-0">
      <thead>
        <tr>
          <th>User</th>
          <th>Role</th>
          <th>IP Address</th>
          <th>Browser</th>
          <th>Last Activity</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr class="table-warning">
          <td>
            <div class="d-flex align-items-center">
              <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                <span class="text-white fw-bold" style="font-size: 0.8rem;">{{ user.first_name.0|default:'U' }}{{ user.last_name.0|default:'S' }}</span>
              </div>
              <div>
                <div class="font-medium">{{ user.get_full_name|default:user.username }}</div>
                <small class="text-muted">Current Session</small>
              </div>
            </div>
          </td>
          <td>
            {% if user.role == 'admin' %}
              <span class="badge bg-danger">Admin</span>
            {% elif user.role == 'manager' %}
              <span class="badge bg-warning">Manager</span>
            {% else %}
              <span class="badge bg-info">User</span>
            {% endif %}
          </td>
          <td>
            <code class="small">{{ request.META.REMOTE_ADDR|default:'127.0.0.1' }}</code>
          </td>
          <td>
            <div class="d-flex align-items-center">
              <i class="bi bi-browser-chrome me-1"></i>
              <span class="small">Chrome</span>
            </div>
          </td>
          <td>
            <span class="small">Just now</span>
          </td>
          <td>
            <span class="badge bg-warning">Current</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Hidden form for CSRF -->
<form id="sessionForm" style="display: none;">
  {% csrf_token %}
</form>
{% endblock %}

{% block extra_scripts %}
<script>
function cleanupSessions() {
  if (!confirm('This will cleanup expired sessions. Continue?')) return;
  
  const csrfToken = document.querySelector('#sessionForm [name=csrfmiddlewaretoken]').value;
  
  fetch('/settings/api/cleanup-sessions/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrfToken,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: 'csrfmiddlewaretoken=' + encodeURIComponent(csrfToken)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showAlert('Cleaned up ' + (data.cleaned_count || 0) + ' expired sessions', 'success');
    } else {
      showAlert('Cleanup failed: ' + (data.error || 'Unknown error'), 'danger');
    }
  })
  .catch(error => {
    showAlert('Network error during cleanup', 'danger');
  });
}

function showAlert(message, type) {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  alert.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.body.appendChild(alert);
  
  setTimeout(() => {
    if (alert.parentNode) alert.remove();
  }, 5000);
}

// Auto-refresh every 30 seconds
setInterval(() => {
  location.reload();
}, 30000);
</script>
{% endblock %}